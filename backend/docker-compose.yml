services:
  app:
    build: .
    container_name: expense-tracker-api
    restart: always
    environment:
      - PORT=3001
      - DATABASE_URL=/app/data/expense-tracker.db
      - JWT_SECRET=${JWT_SECRET:-super_secret_key_change_me}
    volumes:
      - ./data:/app/data:Z
    networks:
      - expense-net

  nginx:
    image: nginx:alpine
    container_name: expense-tracker-nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:Z
      - ./certbot/conf:/etc/letsencrypt:Z
      - ./certbot/www:/var/www/certbot:Z
    command: '/bin/sh -c ''while :; do sleep 6h & wait $${!}; nginx -s reload; done & nginx -g "daemon off;"'''
    depends_on:
      - app
    networks:
      - expense-net

  certbot:
    image: certbot/certbot
    container_name: expense-tracker-certbot
    volumes:
      - ./certbot/conf:/etc/letsencrypt:Z
      - ./certbot/www:/var/www/certbot:Z
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    networks:
      - expense-net

networks:
  expense-net:
    driver: bridge
